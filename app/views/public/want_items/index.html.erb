<% if @end_user.is_deleted == "member" %>
  <div class="container">
    <div class="row no-gutters">
      <div class="col-md-3 p-4">
        <%= render 'public/shared/user_info', end_user: @end_user %>
      </div>

      <div class="col-md-9 py-4">
        <h5 class="headline bg-blue font-weight-bold text-white py-3">
          <span class="text-warning"><i class="fa-solid fa-star"></i></span> <%= @end_user.name %>さんの欲しいもの
        </h5>
        <% if @end_user.want_items_introduction != "" %>
          <div class="balloon-left bg-yellow ml-3 mr-4 mb-2">
            <p class="medium p-2"><%= @end_user.want_items_introduction %></p>
            <% if end_user_signed_in? && current_end_user.screen_name == params[:screen_name] %>
              <div class="text-right medium mt-n3">
                <%= link_to end_user_edit_path, class: "text-dark" do %>
                  <i class="fa-solid fa-pen"></i> 編集
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
        <div class="search-area mx-3 my-4">
          <p class="font-weight-bold mb-0"><i class="fa-solid fa-magnifying-glass"></i> <%= @end_user.name %>さんの欲しいものを探す</p>
          <div class="border border-secondary medium mx-0 p-3">
            <%= search_form_for @q, url: end_user_want_items_path do |f| %>
              <%= f.hidden_field :end_user_id_eq, :value => @end_user.id %>
              <div class="form-group">
                <%= f.search_field :name_cont, placeholder: '商品名から探す', class:'form-control medium' %>
              </div>

              <div class="row">
                <div class="col-md-4">
                  <p class="font-weight-bold mb-1">価格</p>
                  <div class="form-group row no-gutters mb-1">
                    <div class="col-7">
                      <%= f.number_field :price_gteq, class:'form-control medium' %>
                    </div>
                    <label class="col-5 col-form-label pl-1">円以上～</label>
                  </div>
                  <div class="form-group row no-gutters">
                    <div class="col-7">
                      <%= f.number_field :price_lteq, class:'form-control medium' %>
                    </div>
                    <label class="col-5 col-form-label pl-1">円以下</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <p class="font-weight-bold mb-1">カテゴリー</p>
                  <% @chart_want_items.each do |chart_want_item| %>
                    <div class="form-check">
                      <%= f.check_box :category_eq_any, { multiple: true, include_hidden: false, class: 'form-check-input' }, chart_want_item.category, '' %>
                      <%= f.label chart_want_item.category, class:'form-check-label' %>
                    </div>
                  <% end %>
                </div>
                <div class="col-md-4">
                  <div class="d-flex flex-column h-100">
                    <p class="font-weight-bold mb-1">追加した日時</p>
                    <div class="form-group row no-gutters mb-1">
                      <div class="col-11">
                        <%= f.date_field :created_at_gteq, include_blank: true, class:'form-control medium' %>
                      </div>
                      <label class="col-1 col-form-label pl-1">～</label>
                    </div>
                    <div class="form-group row no-gutters">
                      <div class="col-11">
                        <%= f.date_field :created_at_lteq_end_of_day, include_blank: true, class:'form-control medium' %>
                      </div>
                    </div>
                    <div class="text-right">
                      <%= f.submit '検索する', class: "btn btn-secondary btn-sm" %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <div class="row no-gutters mx-2 px-2">
          <div class="col-lg-4">
            <h6 class="subheading2 font-weight-bold my-1"><%= @end_user.name %>さんが欲しいものに追加した商品のカテゴリー比率</h6>
                <div class="chart px-2 py-3 mx-auto" style="position:relative; width:90%; height:auto;">
                  <canvas id="MyReviewChart"></canvas>
                </div>
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script>
                  const ctx = document.getElementById('MyReviewChart');
                  new Chart(ctx, {
                    type: 'pie',
                    data: {
                      labels: [
                          <% @chart_want_items.each do |chart_want_item| %>
                            "<%= chart_want_item.category %>",
                          <% end %>
                          ],
                      datasets: [{
                        data: [
                          <% @chart_want_items.each do |chart_want_item| %>
                            <%= WantItem.where(category: chart_want_item.category, end_user_id: @end_user.id ).count.to_i %>,
                          <% end %>
                          ],
                        borderWidth: 1
                      }]
                    },
                    options: {
                      plugins: {
                          legend: false
                      },
                  }
                  });
                </script>
                <div class="category">
                  <dl class="row medium pl-3">
                    <% @chart_want_items.each do |chart_want_item| %>
                      <dt class="col-10 p-0"><%= chart_want_item.category %></dt>
                      <dd class="col-2 p-0 mb-1"><%= WantItem.where(category: chart_want_item.category, end_user_id: @end_user.id ).count.to_i %>件</dd>
                    <% end %>
                  </dl>
                </div>
              </div>

          <div class="col-lg-8">
            <% if @q.end_user_id_eq != nil %>
              <% @search_items.each do |search_item| %>
                <div class="card mb-3">
                  <div class="card-header bg-gray d-flex">
                    <p class="flex-grow-1 medium m-0">
                    欲しいものに追加した日時 : <%= search_item.created_at.strftime('%Y/%m/%d') %>
                    </p>
                    <div>
                      <% if end_user_signed_in? && current_end_user.screen_name == params[:screen_name] %>
                        <%= link_to want_items_path(id: search_item.id), method: :delete, class:"text-dark" do %>
                          <i class="fa-solid fa-trash-can"></i>
                        <% end %>
                      <% end %>
                    </div>
                  </p>
                  </div>
                  <div class="row no-gutters">
                    <div class="col-4">
                      <%= image_tag (search_item.image), class: "card-img" %>
                    </div>
                    <div class="col-8">
                      <div class="card-body d-flex flex-column h-100 p-2">
                        <h6 class="card-title font-weight-bold text-limit-long"><%= search_item.name %></h6>
                        <p class="card-text flex-grow-1 medium m-0"><%= number_with_delimiter(search_item.price) %>円</p>
                        <div class="text-right mb-1">
                          <%= link_to search_item.url, target: :_blank, class:"btn btn-danger btn-sm px-4" do %>
                            <i class="fa-solid fa-cart-shopping"></i> 楽天市場で見る <i class="fa-solid fa-angles-right"></i>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            <% else %>
              <% @want_items.each do |want_item| %>
                <div class="card mb-3">
                  <div class="card-header bg-gray d-flex">
                    <p class="flex-grow-1 medium m-0">
                    欲しいものに追加した日時 : <%= want_item.created_at.strftime('%Y/%m/%d') %>
                    </p>
                    <div>
                      <% if end_user_signed_in? && current_end_user.screen_name == params[:screen_name] %>
                        <%= link_to want_items_path(id: want_item.id), method: :delete, class:"text-dark" do %>
                          <i class="fa-solid fa-trash-can"></i>
                        <% end %>
                      <% end %>
                    </div>
                  </p>
                  </div>
                  <div class="row no-gutters">
                    <div class="col-4">
                      <%= image_tag (want_item.image), class: "card-img" %>
                    </div>
                    <div class="col-8">
                      <div class="card-body d-flex flex-column h-100 p-2">
                        <h6 class="card-title font-weight-bold text-limit-long"><%= want_item.name %></h6>
                        <p class="card-text flex-grow-1 medium m-0"><%= number_with_delimiter(want_item.price) %>円</p>
                        <div class="text-right mb-1">
                          <%= link_to want_item.url, target: :_blank, class:"btn btn-danger btn-sm px-4" do %>
                            <i class="fa-solid fa-cart-shopping"></i> 楽天市場で見る <i class="fa-solid fa-angles-right"></i>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
        <div class="row justify-content-center medium mt-4">
          <%= paginate @want_items, class: "medium" %>
        </div>

      </div>
    </div>
  </div>
<% else %>
  <div class="container-fluid bg-yellow text-center p-5">
    <div class="my-5 py-4">
      <span class="display-2"><i class="fa-solid fa-user-slash"></i></span>
      <h1 class="sign_in font-weight-bold">Not Found.</h1>
      <p class="mb-5 py-5">
        お探しページは退会済みユーザーのものです。
      </p>
    </div>
  </div>
<% end %>
